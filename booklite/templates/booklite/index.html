
<html>

<head>
	<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
	<script src="https://unpkg.com/axios/dist/axios.min.js"></script>

	{% load static %}
	<script src="{% static 'booklite/secrets.js' %}"></script>
	<style>
		* {
			box-sizing: border-box
		}

		html {
			background-color: #680b22;	
		}

		.header {
			background-color: #680b22;
			color: #ffffff;
			padding: 15px;
			text-align: center;
		}
		#search_div{
			margin-bottom: 50px;
			text-align: center
		}

		.book_entry {
			display: flex;
			flex-direction: row;
			margin: auto;
			margin-bottom: 10px;
			width: 50%;
			color: #ffffff;
			align-items: center;
		}
		.cover_img {
			width: 150px;
			height: auto;
		}
		
		.book_results_info {
			display: flex; flex-direction: column;
			margin-left: 10px;	
			align-content: center;
			width: 100%;		
		}

		.title_span {
			margin-bottom: 10px;
			font-size: 25px;

		}

		.author_span {
			margin-bottom: 10px;
			font-size: 20px; 

		}

		.published_span {

		}

		.ebook_span {

		}

		.publisher_span {

		}

		.book_description {
			/* height: 6em; */
			/* line-height: 1em; */
			white-space: nowrap; 
  			overflow: hidden;
  			text-overflow: ellipsis;
		}
		.book_description:hover {
			/* overflow: visible; */
		}
		
	</style>
</head>

<body>
	<div class="header">
		<h1>BOOKLITE</h1>
		<h4>Keep Track of the books you want to read</h4>
		<a href="{% url 'booklite:logout_user' %}">Logout</a>
	</div>

		<div id="app">

			<div id="search_div">
			<input type="text" v-model="search_text" placeholder="Book Title and/or Author">			
			<button v-on:click="search">Search</button>
			</div>

			<div v-for="book in books" class="book_entry">
				<img v-bind:src="book.cover_url" class="cover_img"/>
				<div class="book_results_info">
					<span class="title_span">[[book.title]]</span>
					<span class="author_span">[[book.authors]]</span>
					<span class="published_span">[[book.published]]</span>
					<span class="ebook_span">[[book.is_ebook]]</span>
					<span class="publisher_span">[[book.publisher]]</span>
					<div class="book_description">[[book.description]]</div>
					<button v-on:click="save_book(book)">Save</button>
				</div>				
			</div>
		</div>
		<script>
			var app = new Vue({
				el: '#app',
				delimiters: ['[[', ']]'],
				data: {
					search_text: '',
					books: []
				},
				methods: {
					search: function (event) {
						let app = this// otherwise 'this' won't be recognized in the callback (.then(function below))
						let url_search = "https://www.googleapis.com/books/v1/volumes?"
						axios.get(url_search, {
							params: {
								q: this.search_text
							}
						}, key = google_books_api_key)
						.then(function (response) {
							app.books = []   //clear out prev search
							let items = response.data.items
							console.log(items)
							for (let i = 0; i < items.length; ++i) {
								let title = items[i].volumeInfo.title
								let authors = ''
								if (items[i].volumeInfo.authors)
									authors = items[i].volumeInfo.authors.join(', ')
								// if (items[i].volumeInfo.authors)
								let description = items[i].volumeInfo.description	
								let published = items[i].volumeInfo.publishedDate
								let publisher = items[i].volumeInfo.publisher
								let cover_url = 'https://blog.springshare.com/wp-content/uploads/2010/02/gc-md.gif'
								if (items[i].volumeInfo.imageLinks)
									cover_url = items[i].volumeInfo.imageLinks.thumbnail 
								let is_ebook = items[i].saleInfo.isEbook
								let pagecount = items[i].volumeInfo.pageCount
								let isbn_array = ''
								if (items[i].volumeInfo.industryIdentifiers)
									isbn_array = items[i].volumeInfo.industryIdentifiers
								let isbn = ''
								for (let i=0; i<isbn_array.length; i++) {
									if (isbn_array[i].type == "ISBN_13"){
										isbn = isbn_array[i].identifier
									}

								}
									
								if (is_ebook)
									is_ebook = "Ebook Edition"
								else
									is_ebook = ""
								app.books.push({
									title: title,
									authors: authors,
									published: published,
									publisher: publisher,
									cover_url: cover_url,
									is_ebook: is_ebook,
									description: description,
									pagecount: pagecount,
									isbn: isbn
									
								})
							}
							
						})
					},
					save_book: function (book) {
						console.log(book)
						axios.post("{% url 'booklite:save_book' %}",
							{
								'title': book.title,
								'author': book.authors,							
								'cover_url': book.cover_url,
								'description': book.description, 
								'published': book.published,
								'publisher': book.publisher,
								'pagecount': book.pagecount,
								'isbn': book.isbn

							}, {
								headers: {
									"X-CSRFToken": "{{ csrf_token }}"
								}
							}
						).then(function(response) {
							console.log(response)
						})
					}
				}
			})

			
            
		</script>
</body>



</html>